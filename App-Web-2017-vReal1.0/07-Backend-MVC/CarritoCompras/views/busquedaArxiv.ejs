<!--Para recomendar desde wikindx-->

<html ng-app="appRecommender">

<head>
  <script>
    var arrayURIS = new Array();
    var arrayValores = new Array();
    var prefixs = "PREFIX id:   <http://acm.rkbexplorer.com/id/>"+
      "PREFIX rdf:  <http://www.w3.org/1999/02/22-rdf-syntax-ns#>"+
      "PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>"+
      "PREFIX akt:  <http://www.aktors.org/ontology/portal#>"+
      "PREFIX owl:  <http://www.w3.org/2002/07/owl#>"+
      "PREFIX akt:  <http://www.aktors.org/ontology/portal#>"+
      "PREFIX akts: <http://www.aktors.org/ontology/support#>"

    //add Jonathan start
    var prefixIeee = "PREFIX id:   <http://ieee.rkbexplorer.com/id/>\n"+
      "PREFIX rdf:  <http://www.w3.org/1999/02/22-rdf-syntax-ns#>\n" +
      "PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>\n" +
      "PREFIX akt:  <http://www.aktors.org/ontology/portal#>\n" +
      "PREFIX owl:  <http://www.w3.org/2002/07/owl#>\n" +
      "PREFIX iai: <http://www.iai.uni-sb.de/resist#>\n"+
      "PREFIX akts: <http://www.aktors.org/ontology/support#>\n" +
      "PREFIX extension: <http://www.aktors.org/ontology/extension#>\n\n"
    //add Jonathan end

    function exec() {
      var endpoint = d3.select("#endpoint").property("value")
      var sparql = d3.select("#sparql").property("value")
      d3sparql.query(endpoint, sparql, render)
    }

    function render(json) {
      var config = {
        "selector": "#result"
      }
      d3sparql.htmltable2(json, config)
    }

    ////////////////////////////////////////////////////////////////////////////////add Jonathan start

    function  web(button){
      // $("#metadataACM").modal({backdrop: 'static', keyboard: false})
      var idButton = button.id
      var resIdBuuton = idButton.replace("btn", '');
      var valueQueryTitle = $("#btn"+resIdBuuton).text()


      // query to find the URI of the title found
      var sparqlURI = prefixIeee + "SELECT DISTINCT ?titleUri WHERE { ?titleUri akt:has-title ?p. filter (?p='" +valueQueryTitle+"')}"
      var endpoint = d3.select("#endpoint").property("value")
      d3sparql.query(endpoint, sparqlURI,almURI)

      function  almURI(json){   //function to result of sparqlURI
        var dataURI = json.results.bindings;
        var valueQuery = dataURI[0].titleUri.value
        var endpoint = d3.select("#endpoint").property("value")
        console.log("valueQuery",valueQuery)
        //query sparql
        sparqlTittle = prefixIeee + "SELECT DISTINCT ?title WHERE {<" +valueQuery+"> akt:has-title ?title}"
        sparqlAuthor = prefixIeee + "SELECT DISTINCT ?nameAutor WHERE {<" +valueQuery+"> akt:has-author ?a.?a akt:full-name ?nameAutor}"
        sparqlDate = prefixIeee + "SELECT DISTINCT ?date WHERE {<" +valueQuery+"> akt:has-date ?a.?a akts:has-pretty-name ?date}"
        sparqlAbstract = prefixIeee + "SELECT DISTINCT ?abstract WHERE {<" +valueQuery+"> extension:has-abstract ?abstract}"
        sparqlKeyword1 = prefixIeee + "SELECT DISTINCT ?keyword1 WHERE {<" +valueQuery+"> akt:has-ieee-keyword ?keyword1 }"
        sparqlJournal = prefixIeee + "SELECT DISTINCT ?TittleJournal ?webJournal ?dateJournalYears \n" +
          "WHERE {<" +valueQuery+"> akt:paper-in-proceedings ?a.\n" +
          "?a akt:has-title ?TittleJournal.\n"+
          "?a akt:has-web-address ?webJournal.\n"+
          "?a akt:has-date ?b.?b akts:year-of ?dateJournalYears}"
        sparqlWeb = prefixIeee + "SELECT DISTINCT ?web WHERE {<" +valueQuery+"> akt:has-web-address ?web.}"
        //add query sparql to textarea
        $("#sparqlTittle").text(sparqlTittle);
        $("#sparqlAuthor").text(sparqlAuthor);
        $("#sparqlDate").text(sparqlDate);
        $("#sparqlAbstract").text(sparqlAbstract);
        $("#sparqlKeyword").text(sparqlKeyword1);

        $("#sparqlJournal").text(sparqlJournal);
        $("#sparqlWeb").text(sparqlWeb);
        //add value of textarea to d3sparql
        var sparqlTittle = d3.select("#sparqlTittle").property("value")
        var sparqlAuthor = d3.select("#sparqlAuthor").property("value")
        var sparqlDate = d3.select("#sparqlDate").property("value")
        var sparqlAbstract = d3.select("#sparqlAbstract").property("value")
        var sparqlKeyword1 = d3.select("#sparqlKeyword").property("value")
        var sparqlJournal = d3.select("#sparqlJournal").property("value")
        var sparqlWeb = d3.select("#sparqlWeb").property("value")
        //query d3sparql
        d3sparql.query(endpoint, sparqlTittle,almTittle)
        d3sparql.query(endpoint, sparqlAuthor,almAuthor)
        d3sparql.query(endpoint, sparqlDate,almDate)
        d3sparql.query(endpoint, sparqlAbstract,almAbstract)
        d3sparql.query(endpoint, sparqlKeyword1,almKeyword1)
        d3sparql.query(endpoint, sparqlJournal,almJournal)
        d3sparql.query(endpoint, sparqlWeb,almWeb)
        //result d3sparql
        function  almTittle(json){
          var dataTittle = json.results.bindings;
          if(Object.entries(dataTittle).length != 0 ){
            $("#titleEEE").val(dataTittle[0].title.value)
            $("#titleEEE").css({"font-style": "normal"})
            console.log("Titulo: ",dataTittle[0].title.value);
          }
          else{
            $("#titleEEE").val("");
            $("#titleEEE").attr("placeholder","without title!, can you edit the title?")
            $("#titleEEE").css({"font-style": "italic"})
          }
        }
        function  almAuthor(json){
          var dataAuthor = json.results.bindings;
          var allAuthor = new Array()
          var allNameAuthor = new Array()
          var allLastNameAuthor = new Array()

          if(Object.entries(dataAuthor).length != 0 ){
            for( i = 0;i<dataAuthor.length;i ++){
              allAuthor.push(dataAuthor[i].nameAutor.value)
              console.log("Autor: ",dataAuthor[i].nameAutor.value);
              var arrayNameAuthor = dataAuthor[i].nameAutor.value.split(" ");
              if(arrayNameAuthor.length == 4){
                allNameAuthor.push(arrayNameAuthor[0]);
                allLastNameAuthor.push(arrayNameAuthor[2]);
              }
              else if (arrayNameAuthor.length == 3){
                allNameAuthor.push(arrayNameAuthor[0]);
                allLastNameAuthor.push(arrayNameAuthor[2]);
              }
              else if (arrayNameAuthor.length == 2){
                allNameAuthor.push(arrayNameAuthor[0])
                allLastNameAuthor.push(arrayNameAuthor[1]);
              }
              else if (arrayNameAuthor.length == 1){
                allNameAuthor.push(arrayNameAuthor[0])
                allLastNameAuthor.push(null);
              }
            }
            $("#authorIEEE").val(allAuthor)
            $("#authorIEEE").css({"font-style": "normal"})

            if ((allAuthor.length == allNameAuthor.length)&&(allAuthor.length == allLastNameAuthor.length) ){

              ///////////////////////////////////Add author to wikindx////////////////////////
              var iCnt = 0;
              var container = $(document.createElement('div'))  // Crear un elemento div añadiendo estilos CSS
              if (iCnt <= 20) {
                iCnt = iCnt + 1;
                // Añadir mero de autores.
                $(container).append('<input hidden type="number"  class="input"  id=tb'+ iCnt + ' '+
                  'name="numero_autores" value="'+dataAuthor.length+'"><br>');

                allAuthor.toString();
                $(container).append('<input hidden type="text" id="author" name="authores" value="'+allAuthor+'"><br>');

                for ( var i = 0; i< allAuthor.length ; i ++ ) {
                  if ( i == 0){ // añadir nombre y apellido de cada autor
                    $(container).append('<input hidden type="text" id= "nameIEEE" name=nombreAuthores value="'+allNameAuthor[i]+'">');
                    $(container).append('<input hidden type="text" id= "lastNameIEEE" name=apellidoAuthores value="'+allLastNameAuthor[i]+'">');
                  }
                  else {
                    $(container).append('<input hidden type="text" id= "nameIEEE" name=nombreAuthores'+i+' '+'value="'+allNameAuthor[i]+'">');
                    $(container).append('<input hidden type="text" id= "lastNameIEEE" name=apellidoAuthores'+i+' '+'value="'+allLastNameAuthor[i]+'">');
                  }
                }
                $('#AuthorsWikindx').after(container);
              }
              else {      //se establece un limite para añadir elementos, 20 es el limite
                $(container).append('<label>Limite Alcanzado de Autores permitidos</label>');
              }
              //borrar informacion al dar click fuera del modal
              $("html").click(function() {
                $(container).empty();
                $(container).remove();
                iCnt = 0;
              });
              $('#metadataACM').click(function (e) {
                e.stopPropagation();
              });
              $('.btRemoveAll').click(function() {    // Elimina todos los elementos del contenedor
                $(container).empty();
                $(container).remove();
                iCnt = 0;
              });
              ////////////////////////////////////// END Add author to wikindx///////////////////////////////
            }else{
              console.error('Error!!!, números de autores no condice => (allAuthor,allNameAuthor,allLastNameAuthor)');
            }
          }else {
            $("#authorIEEE").val("");
            $("#authorIEEE").attr("placeholder","without authors!, can you edit the authors?")
            $("#authorIEEE").css({"font-style": "italic"})
          }
        }
        function  almDate(json){
          var dataDate = json.results.bindings;
          if(Object.entries(dataDate).length != 0 ){
            $("#dateIEEE").val(dataDate[0].date.value)
            $("#dateIEEE").css({"font-style": "normal"})
            console.log("Fecha: ",dataDate[0].date.value);
          }else {
            $("#dateIEEE").val("");
            $("#dateIEEE").attr("placeholder","without date!, can you edit the date?")
            $("#dateIEEE").css({"font-style": "italic"})
          }
        }
        function  almAbstract(json){
          var dataAbstract = json.results.bindings;

          if(Object.entries(dataAbstract).length != 0 ){
            $(".abstractIEEE").val(dataAbstract[0].abstract.value)
            $(".abstractIEEE").css({"font-style": "normal"})
            console.log("Abstract: ",dataAbstract[0].abstract.value);
          }else {
            $(".abstractIEEE").val("");
            $(".abstractIEEE").attr("placeholder","without abstract!, can you edit the abstract?")
            $(".abstractIEEE").css({"font-style": "italic"})
          }
        }
        function  almKeyword1(json){
          var allKeyword = new Array()
          var dataKeyword = json.results.bindings;
          console.log("Palabras clave oakland: ", dataKeyword ); //query for ieee-publications-oakland.rdf (dataset IEEE)
          if(Object.entries(dataKeyword).length != 0 )
          {
            for(i = 0; i<dataKeyword.length;i++){
              allKeyword.push(dataKeyword[i].keyword1.value)
              console.log("Palabras clave oakland: ",dataKeyword[i].keyword1.value);  //query for ieee-publications-oakland.rdf (dataset IEEE)
            }
            $("#keywordIEEE").val(allKeyword)
            $("#keywordIEEE").css({"font-style": "normal"})
          }
          else {
            sparqlKeyword2 = prefixIeee + "SELECT DISTINCT ?keyword2 WHERE {<" +valueQuery+"> iai:has-ieee-keyword ?keyword2 }"
            $("#sparqlKeyword").text(sparqlKeyword2);
            var sparqlKeyword2 = d3.select("#sparqlKeyword").property("value")
            d3sparql.query(endpoint, sparqlKeyword2,almKeyword2)

            function  almKeyword2(json){
              var allKeyword2 = new Array()
              var dataKeyword2 = json.results.bindings;
              console.log("Palabras clave ftcs: ", dataKeyword2 ); //query for ieee-publications-ftcs.rdf (dataset IEEE)
              if(Object.entries(dataKeyword2).length != 0 )
              {
                for(i = 0; i<dataKeyword2.length;i++){
                  allKeyword2.push(dataKeyword2[i].keyword2.value)
                  console.log("Palabras clave ftcs: ",dataKeyword2[i].keyword2.value); //query for ieee-publications-ftcs.rdf (dataset IEEE)
                }
                $("#keywordIEEE").val(allKeyword2)
                $("#keywordIEEE").css({"font-style": "normal"})

              }else{
                $("#keywordIEEE").val("");
                $("#keywordIEEE").attr("placeholder","without keywords!, can you edit the keywords? ")
                $("#keywordIEEE").css({"font-style": "italic"})

              }
            }
          }
        }
        function  almJournal(json){
          var dataJournal = json.results.bindings;
          if(Object.entries(dataJournal).length != 0 ){
            $("#journalIEEE").val(dataJournal[0].TittleJournal.value)
            $("#journalDateIEEE").val(dataJournal[0].dateJournalYears.value)
            $("#journalWebAddressIEEE").val(dataJournal[0].webJournal.value)
            $("#journalIEEE").css({"font-style": "normal"})
            $("#journalDateIEEE").css({"font-style": "normal"})
            $("#journalWebAddressIEEE").css({"font-style": "normal"})
            console.log("Titulo Journal: ",dataJournal[0].TittleJournal.value);
            console.log("Fecha journal: ",dataJournal[0].dateJournalYears.value);
            console.log("Web Journal: ",dataJournal[0].webJournal.value);
          }else {
            $("#journalIEEE").val("");
            $("#journalDateIEEE").val("");
            $("#journalWebAddressIEEE").val("");
            $("#journalIEEE").attr("placeholder","without journal!, can you edit the journal?")
            $("#journalDateIEEE").attr("placeholder","without journal Date!, can you edit the journal Date?")
            $("#journalWebAddressIEEE").attr("placeholder","without journal web address!, can you edit the journal web address?")
            $("#journalIEEE").css({"font-style": "italic"})
            $("#journalDateIEEE").css({"font-style": "italic"})
            $("#journalWebAddressIEEE").css({"font-style": "italic"})
          }
        }
        function  almWeb(json){
          var dataWeb = json.results.bindings;
          if(Object.entries(dataWeb).length != 0 ){
            $("#webIEEE").val(dataWeb[0].web.value);
            $("#webAddress").text(dataWeb[0].web.value).attr("href",dataWeb[0].web.value);
            $("#webIEEE").css({"font-style": "normal"})
            console.log("Web: ",dataWeb[0].web.value);
          }else {
            $("#webIEEE").val("");
            $("#webIEEE").attr("placeholder","without web!, can you edit the web?")
            $("#webIEEE").css({"font-style": "italic"})
            $("#webAddress").text("");

          }

        }
      } // end function to result of sparqlURI
    }
    //////////////////////////////////////////////////////////////////////////////////add Jonathan end
  </script>
</head>

<body ng-controller="Controller">

<div class="row">
  <div class="col-3"></div>
  <div class="col-6">
    <h1> Article saved successfully!!! </h1>
  </div>
  <div class="col-3"></div>
</div>
<br><br><br><br><br>
<div class="row">
  <div class="col-sm-8">


    <div class="alert alert-success" role="alert">
      <h4 class="alert-heading">Well done!</h4>
      <p>Este es el articulo que guardaste.</p>
      <hr>
      <p class="mb-0">
        <input class="form-control" id="titleArticle" type="text"  value="<%= nuevoArticulo.title %>" disabled>
        <br>
        <input hidden id="endpoint" class="span5" value="http://ieee.rkbexplorer.com/sparql/" type="text"  size=30 >
        <button type="button" class="btn btn-primary" data-toggle="button" aria-pressed="false" autocomplete="off" onclick="exec()">
          Recomendaciones
        </button>
        <textarea hidden id="sparql" class="span9" rows=15 cols="100"></textarea>
      </p>
    </div>
  </div>
  <div class="col-sm-4">



    <div class="card alert alert-warning mb-3" style="max-width: 18rem;">
      <div class="card-header alert alert-danger">Recommender module</div>
      <div class="card-body">
        <h5 class="card-title"></h5>
        <p class="card-text">Ingresar al modulo de recomenación para encontrar articulos relacionados con su busqueda.</p>
        <a href="/recommendationsWkx">
          <button type="button" class="btn btn-danger btn-lg">Ingresar</button>
        </a>
      </div>
    </div>

  </div>
</div>



<br><br><br>
<div class="row">
  <div class="col-sm-10">
    <div id="result"></div>
  </div>
  <div class="col-sm-2"></div>
</div>

<!-- Button trigger modal -->
<!-- Modal -->
<div class="modal fade" id="metadataACM" tabindex="-1" role="dialog" aria-labelledby="metadataACMTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">

      <form class="formWikindx" action='/Wkx_category/crearArticuloQuemado' method='post'>

        <div class="modal-header">
          <h5 class="modal-title" id="metadataACMTitle">Metadatos</h5>
          <button type="button" class="btRemoveAll close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <textarea hidden id="sparqlTittle" class="span9" rows=15></textarea>
          <textarea hidden id="sparqlAuthor" class="span9" rows=15></textarea>
          <textarea hidden id="sparqlDate" class="span9" rows=15></textarea>
          <textarea hidden id="sparqlAbstract" class="span9" rows=15></textarea>
          <textarea hidden id="sparqlKeyword" class="span9" rows=15></textarea>
          <textarea hidden id="sparqlJournal" class="span9" rows=15></textarea>
          <textarea hidden id="sparqlWeb" class="span9" rows=15></textarea>
          <div id="resultMetadata"></div>
          <div class="row">
            <div class="col-md-12">
              <div class="card">
                <div class="fondo">
                  <div class="form-group row">
                    <label class="col-2 col-form-label">titulo:</label>
                    <div class="col-10">
                      <input class="form-control" type="text"  value="" id="titleEEE" name="title">
                    </div>
                  </div>
                  <div class="form-group row">
                    <label class="col-2 col-form-label">Autores:</label>
                    <div class="col-10">
                      <input class="form-control" type="text"  value="" id="authorIEEE">
                    </div>
                    <div hidden class="col-10" id="AuthorsWikindx">
                    </div>
                  </div>
                  <div class="form-group row">
                    <label class="col-2 col-form-label">fecha:</label>
                    <div class="col-10">
                      <input class="form-control" type="text"  value="" id="dateIEEE" name="year">
                    </div>
                  </div>
                  <div class="form-group row">
                    <label class="col-2 col-form-label">abstrac:</label>
                    <div class="col-10">
                      <input hidden class="abstractIEEE form-control" type="text"  value="" name="abstract">
                      <textarea
                        class="abstractIEEE"
                        id="textareaModal"
                        value=""
                        cols="45" rows="3"
                      ></textarea>

                    </div>
                  </div>
                  <div class="form-group row">
                    <label class="col-2 col-form-label">Keyword:</label>
                    <div class="col-10">
                      <input class="form-control" type="text"  value="" id="keywordIEEE" name="keywords">
                    </div>
                  </div>
                  <div class="form-group row">
                    <label class="col-2 col-form-label">Direccion Web:</label>
                    <div class="col-10">
                      <input class="form-control" type="text"  value="" id="webIEEE" name="link"/>
                    </div>
                  </div>
                  <div class="form-group row">
                    <label class="col-2 col-form-label">Revista:</label>
                    <div class="col-10">
                      <input class="form-control" type="text"  value="" id="journalIEEE" name="journal">
                      <input hidden type='text' name='typejournal' value='journal'>
                    </div>
                  </div>
                  <div class="form-group row">
                    <label class="col-2 col-form-label">Año Revista:</label>
                    <div class="col-10">
                      <input class="form-control" type="text"  value="" id="journalDateIEEE" name="journalDateIEEE">
                    </div>
                  </div>
                  <div class="form-group row">
                    <label class="col-2 col-form-label">Web Revista:</label>
                    <div class="col-10">
                      <input class="form-control" type="text"  value="" id="journalWebAddressIEEE" name="journalWebAddressIEEE">
                    </div>
                  </div>
                </div>
              </div>
              <p id="webAddressLink"> Visitar Direccion Web del recurso: </p><a id="webAddress"></a>
            </div>
          </div>
        </div>


        <div class="modal-footer">
          <button type="button" class="btRemoveAll btn btn-secondary" data-dismiss="modal" >Close</button>
          <button type="submit" class="btn btn-primary" >Save</button>
        </div>

      </form>
    </div>
  </div>
</div>
<!-- end Modal -->

<br><br><br><br><br>

<script>
  var app = angular.module("appRecommender",[]);
  app.controller("Controller",function ($scope,$http) { //start angular

    $(document).ready(function(){  //start jquery
      ///////////////////////// QUERY OF KEYWORDS TO TITLE //////////////////////////////
      var title = $("#titleArticle").val();    //get value of title
      var queryHeader = "SELECT DISTINCT ?TITULO \n"+
        "WHERE { ?p akt:has-title ?TITULO. FILTER (\n"        //header of query
      var queryFooter = ")}"    //footer of query
      var stringRegex = new Array ()    // string that contains the value of function regex of SPARQL
      var arrayOfString  // string that contains the value of the title
      var cont  = 0  //counter used in the while loop
      var keywordsTitle = ""  // final result to include in the SPARQL query
      var spaceSeparator = " ";  //separator for the argument of the function StringToSplit()

      function splitString (StringToSplit,separator){

        arrayOfString = StringToSplit.split(separator);
        console.log("arrayOfString.length", arrayOfString.length)

        // add words of title in function regex (SPARQL)
        for (var j=0;j<arrayOfString.length;j++){
          if(j != (arrayOfString.length-1)){
            stringRegex.push("regex(str(?TITULO), '"+arrayOfString[j]+"', 'i')||\n");
          }else{
            stringRegex.push("regex(str(?TITULO), '"+arrayOfString[j]+"', 'i')\n");
          }
        }
        // add results to variable keywordsTitle
        while ( cont < arrayOfString.length ) {
          keywordsTitle += stringRegex[cont];
          cont++
        }

        $("#sparql").text(prefixIeee + queryHeader + keywordsTitle +queryFooter); // send query to VIEW (#sparql)
      };

      splitString(title,spaceSeparator);

//////////// RESULTS TABLE OF FIRTS QUERY (d3sparql.htmltable2) //////////////////////////////
      d3sparql.htmltable2 = function(json, config) {
        config = config || {}
        var head = json.head.vars
        var data = json.results.bindings
        var opts = {
          "selector": config.selector || null
        }
        var table = d3sparql.select(opts.selector, "htmltable").append("table").attr("class", "table table-bordered")
        var thead = table.append("thead")
        var tbody = table.append("tbody")
        thead.append("tr")
          .selectAll("th")
          .data(head)
          .enter()
          .append("th")
          .text(function(col) { return col })
        var rows = tbody.selectAll("tr")
          .data(data)
          .enter()
          .append("tr")
        var cells = rows.selectAll("td")
          .data(function(row) {
            return head.map(function(col) {
              return row[col].value

            })
          })
          .enter()
          .append("td")
          .append("lu")
          .append("li")
          .append("button")
          .text(function(val) {return val })
        // default CSS

        table.style({
          "margin": "10px"
        })
        table.selectAll("th").style({
          "background": "#eeeeee",
          "text-transform": "capitalize",
        })
        for(i=0 ; i<data.length*2 ; i++) {


          $("tbody tr td lu li:eq("+i+")").css("list-style","none")//quita el punto de la lista
          $("tbody tr td lu li:eq("+i+") button").attr("id","btn"+i)

            .attr({
              "class": "btn btn-outline-success btn-lg btn-block",
              "data-toggle": "modal",
              "data-target": "#metadataACM",
              "onclick":"web(this)"
            })
        }
      }
    });   //end jquery
  }); //end angular
  /////////////////////////////// end angular
</script>
<br>
<br>
<br>
</body>
</html>


<!--(end) added for Recommender Module-->












